# 自动化部署分支构建

## 起因

之前在写[Gatsby 入门](https://segmentfault.com/a/1190000022690322)的时候,写了一个[示例仓库](https://github.com/XYShaoKang/gatsby-hello-world),在写示例仓库的过程,想要把实际的效果部署成`GitHub Pages`,这样可以直接查看最终的效果.我选择通过`Travis-CI`来做部署,当有新的提交时,会自动去部署,将`GitHub Pages`更新.

使用`Travis-CI`需要在仓库里面放一个配置文件`.travis.yml`,并且需要添加额外依赖`gh-pages`和修改`gatsby-config.js`,这样会让仓库变复杂,另外我想能够让别人直接通过`gatsby new`来使用这个仓库,这样如果多了其余的东西就不合适了,所以我在`master`的基础上新建了一个`deploy`分区,专门用于部署用,`master`里面还是只保留自身需要的代码,而不用增加其他部署需要的配置.

可是这样又出现了新的问题,当我在`master`里更新代码时,为了保持两个分支的同步,我需要切换到`deploy`分支中将`master`的更新同步过来,在执行推送,这样让每次更新代码变得很繁琐.

虽然可以通过合并命令,只需要执行一次就够了,但是看着很难受.我在想能不能只在`master`分支里更新,而其他操作都通过自动化完成.

在谷歌上搜了一圈,没有发现符合这个场景比较好用的解决方案.所以只能自己动手.

以下是解决这个需求的思路和方案,

## 思路

首先想到的是通过`git hook`,在提交的钩子里,执行脚本,使用`git rebase`将`master`的更新同步到`deploy`,但是使用`git rebase`并不会百分之百成功,会有一个风险,就是两个分支有冲突,就需要手动去编辑来解决冲突,这就不太适合做自动化操作.

后来我想其实`deploy`中并不需要放置`master`的源码,只需要放置部署需要的文件,而`master`中的源码可以通过在构建的时候,从`GitHub`下载既可.

那么只要想办法在`master`推送代码成功时,触发`Travis-CI`中`deploy`分支的构建既可.

## 解决方案

通过查找文档和搜索,发现几个可以利用的地方:

1. `Travis-CI` 可以通过 API 来触发指定的分支执行构建
2. 可以在`GitHub`中添加一个`Webhook`,指定一个地址,当有指定的事件完成时(比如可以指定提交完成事件),会往这个地址发送一次`POST`请求.

只是可惜没法直接让`Webhook`和`Travis-CI`做联动,就只能想办法通过一种中间服务来做一个处理了.

大概流程:

1. 在提交代码时触发
2. 接收提交完成的通知
3. 通知`Travis-CI`进行部署构建

原本`Github Action`是很适合做这种处理的,只是要使用`Action`,需要在`master`中添加额外的配置文件,所以在这里没法使用.另外要使用`Travis-CI`自定义构建的 API,需要在请求时,发送一个`token`,所以不能使用公开的方式,比如不能在`GitHub Pages`中集成一个 API 来处理.

最终解决方案,开发一个 cli 工具,在提交时,触发`pre-push`钩子,使用 cli 在本地搭建服务用来接收`Webhook`,然后继续执行`git push`,提交成功后,本地服务接收到`Webhook`的通知,向`Travis-CI`发送触发自定义构建的请求.

结合自己所学,在 cli 中使用`Koa`来提供服务,使用`pm2`来管理服务,使用`serveo.net`将本地服务端口公开到公网上,并绑定自定义子域名,这样在`Webhook`中绑定一次就可以,不用频繁修改绑定的域名.

## 使用

查看[README](./README.md)
